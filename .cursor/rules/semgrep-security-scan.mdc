---
description: Mandatory security scanning of all generated code using Semgrep MCP server
alwaysApply: true
---
# Rule: Semgrep MCP Security Scan

// Description: Mandatory security scanning of all generated code using Semgrep MCP server
// Globs: **/*.{js,jsx,ts,tsx,py,java,go,rb,php,c,cpp,cs,swift,kt}

## Purpose

This rule ensures that ALL code generated by the AI is automatically scanned for security vulnerabilities using the Semgrep MCP server before being considered complete.

## Mandatory Requirement

**ALWAYS scan code generated using Semgrep for security vulnerabilities when MCP tools are available.**

**If Semgrep MCP tools are NOT available:**
- Perform manual security review focusing on common vulnerabilities
- Document that manual review was performed
- Note any security concerns in code comments
- This is acceptable when MCP tools cannot be configured

## When to Scan

Security scans MUST be performed:
1. After generating any new code files
2. After modifying existing code files
3. Before marking a task as complete
4. Before committing code changes
5. When explicitly requested by the user

## Scan Workflow

1. **Generate Code**: Complete the requested code generation or modification
2. **Check MCP Availability**: Determine if Semgrep MCP tools are available
3. **If MCP Available**: 
   - Run Security Scan: Use Semgrep MCP to scan the generated code
   - Review Results: Analyze any security findings
   - Fix Issues: Address any security vulnerabilities found
   - Re-scan if Needed: Verify fixes with another scan
   - Confirm Clean: Only proceed when no security issues remain
4. **If MCP NOT Available**:
   - Perform Manual Review: Check for common vulnerabilities (SQL injection, XSS, insecure random, hardcoded secrets, etc.)
   - Document Review: Note that manual security review was performed
   - Apply Best Practices: Ensure code follows security best practices (parameterized queries, input validation, etc.)
   - Proceed: Continue with implementation after manual review

## Using Semgrep MCP

The Semgrep MCP server provides several tools for security scanning:

### Available MCP Tools
- `mcp_semgrep_security_check`: Fast security check for code
- `mcp_semgrep_semgrep_scan`: Full Semgrep scan with custom configs
- `mcp_semgrep_semgrep_scan_local`: Scan local files by absolute path
- `mcp_semgrep_semgrep_findings`: Query existing findings from Semgrep AppSec Platform

### Recommended Approach

Use `mcp_semgrep_security_check` for quick validation:
```
mcp_semgrep_security_check({
  code_files: [
    { filename: 'app.js', content: '...' }
  ]
})
```

## Handling Findings

When security issues are discovered:

1. **Report Findings**: Clearly communicate what was found
2. **Explain Impact**: Describe the security implications
3. **Propose Fixes**: Suggest specific remediation steps
4. **Implement Fixes**: Apply the security fixes to the code
5. **Verify**: Re-scan to confirm the issues are resolved

## Best Practices

- **Scan Early**: Run security checks as soon as code is generated
- **Be Proactive**: Don't wait for the user to request a scan
- **Fix Immediately**: Address security issues before moving forward
- **Document**: Note what was scanned and the results
- **Educate**: Explain why certain patterns are insecure

## Example Workflow

```
1. User requests: "Create an authentication endpoint"
2. AI generates the code
3. AI immediately runs security scan
4. If issues found:
   - Report: "Found SQL injection vulnerability"
   - Fix: Update code with parameterized queries
   - Re-scan: Verify the fix
5. Confirm: "Code generated and security verified âœ“"
```

## Security Scan Checklist

Before completing any code generation task:

- [ ] Code has been generated/modified
- [ ] Security verification has been performed (automated scan OR manual review)
- [ ] Results have been reviewed
- [ ] Any findings have been addressed
- [ ] Re-verification confirms no issues remain (if automated scan available)
- [ ] User has been informed of security status
- [ ] If MCP unavailable: Manual review documented and common vulnerabilities checked

## Non-Compliance

Code should NOT be delivered without security verification. If Semgrep MCP scanning is unavailable:

1. **Perform Manual Security Review**: Check for common vulnerabilities
2. **Document the Review**: Note that manual review was performed instead of automated scan
3. **Apply Security Best Practices**: Ensure code follows security guidelines
4. **Inform User**: Note that automated scanning wasn't available but manual review was performed

**Acceptable Alternative**: Manual security review is acceptable when MCP tools cannot be configured, as long as common vulnerabilities are checked.

## Integration with Development Flow

This rule integrates with other development rules:
- Run BEFORE commit message generation
- Run AFTER process task list completion
- Run DURING feature development
- Run BEFORE deployment preparation

## Remember

**Security is not optional. Every line of code generated must be verified for vulnerabilities through automated scanning (preferred) or manual review (acceptable when MCP unavailable).**

## Manual Security Review Guidelines

When Semgrep MCP is unavailable, perform manual review focusing on:

1. **SQL Injection**: Ensure parameterized queries, no string concatenation in SQL
2. **XSS (Cross-Site Scripting)**: Validate and sanitize user inputs
3. **Insecure Random**: Use cryptographically secure random number generators
4. **Hardcoded Secrets**: No API keys, passwords, or tokens in code
5. **Path Traversal**: Validate file paths, use path.join() or equivalent
6. **Command Injection**: Avoid exec() with user input, use safe alternatives
7. **Insecure Dependencies**: Check for known vulnerabilities in dependencies
8. **Authentication/Authorization**: Verify proper access controls
9. **Data Validation**: Validate all inputs, especially from external sources
10. **Error Handling**: Don't expose sensitive information in error messages